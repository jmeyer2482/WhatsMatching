<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="WhatsMatching">
<title>Vignette 2 - The App â€¢ WhatsMatching</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Vignette 2 - The App">
<meta property="og:description" content="WhatsMatching">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">WhatsMatching</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a-Background.html">Vignette 1 - Background</a>
    <a class="dropdown-item" href="../articles/b-Applications.html">Vignette 3 - Applications</a>
    <a class="dropdown-item" href="../articles/c-TheApp.html">Vignette 2 - The App</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jmeyer2482/WhatsMatching/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Vignette 2 - The App</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jmeyer2482/WhatsMatching/blob/HEAD/vignettes/c-TheApp.Rmd" class="external-link"><code>vignettes/c-TheApp.Rmd</code></a></small>
      <div class="d-none name"><code>c-TheApp.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(WhatsMatching)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This Shiny App package has been developed with the intention of
providing educational support for understanding matching methods in the
context of causal inference. The initial intention was to deal
specifically with the Propensity Score Paradox highlighted by King and
Neilsen[ref]. Over the development of the app we decided that the
underlying theoretical concepts that inform how matching is conducted by
might be more useful and engaging in an educational environment. This
document outlines the theoretical concepts and development process that
was undertaken to develop the app.</p>
</div>
<div class="section level2">
<h2 id="matching-visuals">Matching Visuals<a class="anchor" aria-label="anchor" href="#matching-visuals"></a>
</h2>
<p>In order to demonstrate how matching works visually, we will simulate
some data under different conditions to highlight the differences in the
methods. This will purely show how data are matched between groups, we
will look out how that changes the estimate of the treatment effect
later.</p>
<p>All these simulations will contain 60 control units and 40 treated
units and the matches will be completed with both the Propensity Score
and the Mahalanobis Distance.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #treatment has a mild effect on one covariate (1/2 std dev)</span></span>
<span><span class="co"># d$X1.mild &lt;- d$t*2.5 + d$X1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #treatment has a strong effect on one covariate (3 std dev)</span></span>
<span><span class="co"># d$X1.strong &lt;- d$t*15 + d$X1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #treatment has opposite effects on covariates (mild)</span></span>
<span><span class="co"># d$X2.mild &lt;- d$t*-2 + d$X2</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #treatment has opposite effects on covariates (strong)</span></span>
<span><span class="co"># d$X2.strong &lt;- d$t*-12 + d$X2</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># #random, no treatment effect</span></span>
<span><span class="co"># psm.1 &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Propensity Score")</span></span>
<span><span class="co"># mdm.1 &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psp.1 &lt;- plot.matches(psm.1, "Propensity Score Matches - Random Data")</span></span>
<span><span class="co"># mdp.1 &lt;- plot.matches(mdm.1, "Mahalanobis Distance Matches - Random Data")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psm.2 &lt;- WhatsMatching::matched.data(t~X1.mild+X2, d, "Propensity Score")</span></span>
<span><span class="co"># mdm.2 &lt;- WhatsMatching::matched.data(t~X1.mild+X2, d, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psp.2 &lt;- plot.matches(psm.2, "Propensity Score Matches - Mild treatment effect on X1")</span></span>
<span><span class="co"># mdp.2 &lt;- plot.matches(mdm.2, "Mahalanobis Distance Matches - Mild treatment effect on X1")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psm.3 &lt;- WhatsMatching::matched.data(t~X1.strong+X2, d, "Propensity Score")</span></span>
<span><span class="co"># mdm.3 &lt;- WhatsMatching::matched.data(t~X1.strong+X2, d, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psp.3 &lt;- plot.matches(psm.3, "Propensity Score Matches - Strong treatment effect on X1")</span></span>
<span><span class="co"># mdp.3 &lt;- plot.matches(mdm.3, "Mahalanobis Distance Matches - Strong treatment effect on X1")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psm.4 &lt;- WhatsMatching::matched.data(t~X1.mild+X2.mild, d, "Propensity Score")</span></span>
<span><span class="co"># mdm.4 &lt;- WhatsMatching::matched.data(t~X1.mild+X2.mild, d, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psp.4 &lt;- plot.matches(psm.4, "Propensity Score Matches - Mild treatment effect on X1 and X2")</span></span>
<span><span class="co"># mdp.4 &lt;- plot.matches(mdm.4, "Mahalanobis Distance Matches - Mild treatment effect on X1 and X2")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psm.5 &lt;- WhatsMatching::matched.data(t~X1.strong+X2.strong, d, "Propensity Score")</span></span>
<span><span class="co"># mdm.5 &lt;- WhatsMatching::matched.data(t~X1.strong+X2.strong, d, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># psp.5 &lt;- plot.matches(psm.5, "Propensity Score Matches - Strong treatment effect on X1 and X2")</span></span>
<span><span class="co"># mdp.5 &lt;- plot.matches(mdm.5, "Mahalanobis Distance Matches - Strong treatment effect on X1 and X2")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># # ggpubr::ggarrange(psp.1, mdp.1, common.legend = TRUE)</span></span>
<span><span class="co"># # ggpubr::ggarrange(psp.2, mdp.2, common.legend = TRUE)</span></span>
<span><span class="co"># # ggpubr::ggarrange(psp.3, mdp.3, common.legend = TRUE)</span></span>
<span><span class="co"># # ggpubr::ggarrange(psp.4, mdp.4, common.legend = TRUE)</span></span>
<span><span class="co"># # ggpubr::ggarrange(psp.5, mdp.5, common.legend = TRUE)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ggpubr::ggarrange(psp.1,psp.2,psp.3, mdp.1, mdp.2, mdp.3, common.legend = TRUE, legend = "right", align = "hv")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ggpubr::ggarrange(psp.1,psp.4,psp.5, mdp.1, mdp.4, mdp.5, common.legend = TRUE, legend = "right")</span></span></code></pre></div>
<p>For the purposes of simplicity and uniformity the
<code>optmatch</code> package has been used to generate a distance
matrix using the <code>match_on</code> function. The format of the data
that is returned is the same for both the Mahalanobis Distance and the
Propensity Score. Weâ€™ll also be use the <code>fev</code> dataset from
the <code>mplot</code> package which contains a data that is useful for
demonstrating the matching process.</p>
<p>Letâ€™s have a quick look at the data so we know what weâ€™re dealing
with.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># head(dt)</span></span></code></pre></div>
<p>As we can see, there are 5 columns. All the data here is numeric. For
the purpose of this exercise, we want to see what the effect of smoke is
on forced expiratory volume. Therefore, we will use the
<code>smoke</code> variable as the treatment and <code>fev</code> is the
outcome. The remaining covariates are <code>age</code>,
<code>height</code>, and <code>sex</code>.</p>
<p>Letâ€™s have a quick look at the data using <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(dplyr)</span></span>
<span><span class="co"># library(ggplot2)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #add meaningful labels</span></span>
<span><span class="co"># dt &lt;- dt %&gt;% mutate(Sex=ifelse(sex==0,"Female","Male"),</span></span>
<span><span class="co">#                    Smokes=ifelse(smoke==0,"No","Yes"))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p1 &lt;- ggplot(dt, aes(x=Smokes)) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p1.1 &lt;- p1 + geom_boxplot(aes(y=age, fill=Smokes)) </span></span>
<span><span class="co"># p1.2 &lt;- p1 + geom_boxplot(aes(y=height, fill=Smokes))</span></span>
<span><span class="co"># p1.3 &lt;- p1 + geom_count(aes(y=Sex, colour=Smokes))</span></span>
<span><span class="co"># p1.4 &lt;- p1 + geom_boxplot(aes(y=fev, fill=Smokes))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p2 &lt;- ggplot(dt, aes(y=fev)) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p2.1 &lt;- p2 + geom_point(aes(x=age, color=Smokes), alpha=0.5) </span></span>
<span><span class="co"># p2.2 &lt;- p2 + geom_point(aes(x=height, color=Smokes), alpha=0.5)</span></span>
<span><span class="co"># p2.3 &lt;- p2 + geom_boxplot(aes(x=Sex, fill=Smokes))</span></span>
<span><span class="co"># p2.4 &lt;- p2 + geom_boxplot(aes(x=Smokes, fill=Smokes))</span></span></code></pre></div>
<div class="section level4">
<h4 id="fig-1">Fig 1<a class="anchor" aria-label="anchor" href="#fig-1"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ggpubr::ggarrange(p1.1,p1.2,p1.3,p1.4, common.legend = T)</span></span>
<span><span class="va">fig.count</span> <span class="op">&lt;-</span> <span class="va">fig.count</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fig-2">Fig 2<a class="anchor" aria-label="anchor" href="#fig-2"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ggpubr::ggarrange(p2.1,p2.2,p2.3,p2.4, common.legend = T)</span></span>
<span><span class="va">fig.count</span> <span class="op">&lt;-</span> <span class="va">fig.count</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
<p>We can see from this quick look at the data that smokers are older,
taller and appear to have a larger FEV. They are also a small subset of
the overall population in the dataset. If we were to map out the
relationships in a directed acyclic graph, it might look something like
this:</p>
</div>
<div class="section level4">
<h4 id="fig-3">Fig 3<a class="anchor" aria-label="anchor" href="#fig-3"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fig.count &lt;- fig.count + 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #smoke, age, height, sex, fev</span></span>
<span><span class="co"># fev.dag &lt;- dagitty::dagitty('dag{</span></span>
<span><span class="co">#                  age -&gt; height</span></span>
<span><span class="co">#                  sex -&gt; height</span></span>
<span><span class="co">#                  age -&gt; smoke</span></span>
<span><span class="co">#                  height -&gt; fev</span></span>
<span><span class="co">#                  smoke -&gt; height</span></span>
<span><span class="co">#                  smoke -&gt; fev</span></span>
<span><span class="co">#                  age -&gt; fev</span></span>
<span><span class="co">#                  age -&gt; smoke</span></span>
<span><span class="co">#                  smoke [exposure]</span></span>
<span><span class="co">#                  fev [outcome]</span></span>
<span><span class="co">#                  }', layout=FALSE)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dagitty::coordinates(fev.dag) &lt;- </span></span>
<span><span class="co">#   list(x=c(age=0.5,fev=1,height=0.5,sex=0,smoke=0),</span></span>
<span><span class="co">#        y=c(age=0.9,fev=0.5,height=0.1,sex=0,smoke=0.5))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># plot(fev.dag)</span></span></code></pre></div>
<p>We can see from the relationships here that <code>age</code> is a
confounder as it effects both the exposure (<code>smoke</code>) and the
outcome (<code>fev</code>). <code>height</code> is also important as it
is a mediator. <code>sex</code> appears to be completely accounted for
by <code>height</code>. Now that we have the variables for our model,
letâ€™s look at some methods for matching.</p>
<p>There is more than one way of matching units in a dataset. The two
methods we are looking at here are Propensity Score Matching (PSM) and
Mahalanobis Distance Matching (MDM). We will also look at some of the
different specifications you can make when matching.</p>
<p>Propensity score matching is relatively straight forward. Using
logistic regression, create a vector of probabilities based on the
whether or not each unit is likely to have received the treatment (or
been exposed to subject of interested). We will be using
<code>smoke ~ age + height</code> to determine our matches. For
consistency in output between methods, I have used the
<code>optmatch</code> package to generate the distance matrix.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># f &lt;- smoke~age+height</span></span>
<span></span>
<span><span class="co">#fit model</span></span>
<span><span class="co"># fev.mod &lt;- glm(f, data=dt, family="binomial") </span></span>
<span></span>
<span><span class="co">#get matrix using the fitted values from the model (propensity scores)</span></span>
<span><span class="co">#the matrix is generated using the treatment variable (y in the model output) </span></span>
<span><span class="co"># ps.dm &lt;- optmatch::match_on(x=fev.mod$fitted.values, z=fev.mod$y)</span></span></code></pre></div>
<p>If we wanted to do the same thing for MDM then we specify it as per
the optmatch documentation. In terms of the differences between the
distance matrices, the propensity score distance matrix is the distance
(or difference) between the calculated propensity score for each unit
whereas the mahalanobis distance matrix will be the actual distance
between the units based on the covariance matrix of <span class="math inline">\(X\)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Mahalanobis distance matrix</span></span>
<span><span class="co"># md.dm &lt;- optmatch::match_on(x=f, data=dt, method="mahalanobis")</span></span></code></pre></div>
<p>Now that we have a distance matrix for each method we can look at
matching.</p>
<p>At this point we can start to specify how the matching occurs.
Options include:<br>
- whether or not to use replacement<br>
- the order the data is matched in (this is really only important if you
arenâ€™t replacing matches)<br>
- whether or not to use a calliper (and how tight to make it)</p>
<p>This exercise is not looking at the use of a calliper. It is also not
exploring exact matching or other more complex match settings. We will
be doing a simple match without replacement, ordered by the data for
both methods.</p>
<p>Each matrix is <span class="math inline">\(m \times n\)</span> where
<span class="math inline">\(m\)</span> represents the treatment group
and <span class="math inline">\(n\)</span> represents the control group.
To get our matches, we sequentially go through each <span class="math inline">\(m\)</span> and select the <span class="math inline">\(n\)</span> with the smallest value until we get to
the last <span class="math inline">\(m\)</span>. When do this with
replacement there is no regard for whether <span class="math inline">\(n\)</span> has been used before, without
replacement mean that the same <span class="math inline">\(n\)</span>
cannot be used twice. Letâ€™s get some matches!</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># </span></span>
<span><span class="co"># #to make this repeatable I'm just going to wrap this is a function</span></span>
<span><span class="co"># match.ids &lt;- function(dm){ </span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#   #we can get the row and column names from the matrix to make looping a bit easier. </span></span>
<span><span class="co">#   #It will be the same for both methods in this case.</span></span>
<span><span class="co">#   t.names &lt;- attributes(dm)$dimnames$treatment</span></span>
<span><span class="co">#   c.names &lt;- attributes(dm)$dimnames$control</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   # initialise a dataframe for storing matches</span></span>
<span><span class="co">#   ids &lt;- list(treatment=character(),</span></span>
<span><span class="co">#               control=character(),</span></span>
<span><span class="co">#               dist=numeric()</span></span>
<span><span class="co">#   ) %&gt;% as.data.frame()</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   #loop over the distance matrix rows using the order they are already in</span></span>
<span><span class="co">#   for (i in t.names) {</span></span>
<span><span class="co">#     #select the row</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     d &lt;- dm[i,!c.names %in% ids$control]</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     c.val &lt;- names(which.min(d))</span></span>
<span><span class="co">#     if (length(d)==1) c.val &lt;- c.names[!c.names %in% ids$control]</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     a &lt;- list(treatment = i,</span></span>
<span><span class="co">#               control = c.val,</span></span>
<span><span class="co">#               dist = min(d))</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     #add the matched pair to the dataframe</span></span>
<span><span class="co">#     ids &lt;- rbind(ids,a)</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#     row.names(ids) &lt;- 1:nrow(ids)</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   }</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   return(ids)</span></span>
<span><span class="co">#   </span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #we can specify @.Data to get the matrix explictly as the optmatch </span></span>
<span><span class="co"># #object has some other parts we don't require</span></span>
<span><span class="co"># ps.dm &lt;- ps.dm@.Data</span></span>
<span><span class="co"># md.dm &lt;- md.dm@.Data</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #the paired ids for all the matches</span></span>
<span><span class="co"># ps.ids &lt;- match.ids(ps.dm)</span></span>
<span><span class="co"># md.ids &lt;- match.ids(md.dm)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #are the matches the same?</span></span>
<span><span class="co"># table(ps.ids$control==md.ids$control)</span></span></code></pre></div>
<p>OK. Now we have our matches for each method. Letâ€™s see what they look
like visually using <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ps.matches &lt;- rbind(</span></span>
<span><span class="co">#   cbind(dt[ps.ids$treatment,], subclass=ps.ids$treatment),</span></span>
<span><span class="co">#   cbind(dt[ps.ids$control,], subclass=ps.ids$treatment))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># md.matches &lt;- rbind(</span></span>
<span><span class="co">#   cbind(dt[md.ids$treatment,], subclass=md.ids$treatment),</span></span>
<span><span class="co">#   cbind(dt[md.ids$control,], subclass=md.ids$treatment))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mp1 &lt;- ggplot(ps.matches, aes(height, age, group=subclass)) +</span></span>
<span><span class="co">#   geom_point(data=dt, aes(height, age), colour="black", alpha=0.3,</span></span>
<span><span class="co">#              inherit.aes = F, size=1) + </span></span>
<span><span class="co">#   geom_point(aes(color=Smokes), alpha=0.6, size=3) + </span></span>
<span><span class="co">#   geom_line(color="black") +</span></span>
<span><span class="co">#   labs(title="Propensity Score Matching matches")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mp2 &lt;- ggplot(md.matches, aes(height, age, group=subclass)) +</span></span>
<span><span class="co">#   geom_point(data=dt, aes(height, age), colour="black", alpha=0.3,</span></span>
<span><span class="co">#              inherit.aes = F, size=1) + </span></span>
<span><span class="co">#   geom_point(aes(color=Smokes), alpha=0.6, size=3) + </span></span>
<span><span class="co">#   geom_line(color="black") +</span></span>
<span><span class="co">#   labs(title="Mahalanobis Distance Matching matches")</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fig-3-1">Fig 3<a class="anchor" aria-label="anchor" href="#fig-3-1"></a>
</h4>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mp1</span></span>
<span><span class="va">fig.count</span> <span class="op">&lt;-</span> <span class="va">fig.count</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fig-4">Fig 4<a class="anchor" aria-label="anchor" href="#fig-4"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mp2</span></span>
<span><span class="va">fig.count</span> <span class="op">&lt;-</span> <span class="va">fig.count</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
<p>We can see from these two plots that the matches between the groups
are slightly different between methods. For example, the smoker that is
<code>age</code>=15 and <code>height</code>=60 is paired with very
different non-smokers. Overall the matches look quite similar in the
distribution even though there are a few differences between them. Letâ€™s
see if that changes the treatment effect.</p>
<p>There are two ways we can specify how we estimate the treatment
effect on the matched data. The purpose of the matching is to control
confounding and bias. If we are happy that has been done by virtue of
the matching then we need only specify <code>fev ~ smoke</code>.
Alternatively, if we wanted to cover our bases, we could include the
covariates in the model as well -
<code>fev ~ age + height + smoke</code>. Letâ€™s compare them to a model
that contains all the data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># f1 &lt;- fev ~ smoke</span></span>
<span><span class="co"># f2 &lt;- fev ~ height + smoke</span></span>
<span><span class="co"># f3 &lt;- fev ~ age + smoke</span></span>
<span><span class="co"># f4 &lt;- fev ~ age + height + smoke</span></span>
<span><span class="co">#   </span></span>
<span><span class="co"># mod1.1 &lt;- lm(f1, md.matches) </span></span>
<span><span class="co"># mod1.2 &lt;- lm(f1, ps.matches) </span></span>
<span><span class="co"># mod1.3 &lt;- lm(f1, dt) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mod2.1 &lt;- lm(f2, md.matches) </span></span>
<span><span class="co"># mod2.2 &lt;- lm(f2, ps.matches) </span></span>
<span><span class="co"># mod2.3 &lt;- lm(f2, dt)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mod3.1 &lt;- lm(f3, md.matches) </span></span>
<span><span class="co"># mod3.2 &lt;- lm(f3, ps.matches) </span></span>
<span><span class="co"># mod3.3 &lt;- lm(f3, dt)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mod4.1 &lt;- lm(f4, md.matches) </span></span>
<span><span class="co"># mod4.2 &lt;- lm(f4, ps.matches) </span></span>
<span><span class="co"># mod4.3 &lt;- lm(f4, dt)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mod.comp &lt;- rbind(</span></span>
<span><span class="co">#   c(model="Mahalanobis Match", formula=deparse(f1), coef(mod1.1)["smoke"], confint(mod1.1)["smoke",]),</span></span>
<span><span class="co">#   c(model="Propensity Score Match", formula=deparse(f1), coef(mod1.2)["smoke"], confint(mod1.2)["smoke",]),</span></span>
<span><span class="co">#   c(model="Unmatched", formula=deparse(f1), coef(mod1.3)["smoke"], confint(mod1.3)["smoke",]),</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   c(model="Mahalanobis Match", formula=deparse(f2), coef(mod2.1)["smoke"], confint(mod2.1)["smoke",]),</span></span>
<span><span class="co">#   c(model="Propensity Score Match", formula=deparse(f2), coef(mod2.2)["smoke"], confint(mod2.2)["smoke",]),</span></span>
<span><span class="co">#   c(model="Unmatched", formula=deparse(f2), coef(mod2.3)["smoke"], confint(mod2.3)["smoke",]),</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   c(model="Mahalanobis Match", formula=deparse(f3), coef(mod3.1)["smoke"], confint(mod3.1)["smoke",]),</span></span>
<span><span class="co">#   c(model="Propensity Score Match", formula=deparse(f3), coef(mod3.2)["smoke"], confint(mod3.2)["smoke",]),</span></span>
<span><span class="co">#   c(model="Unmatched", formula=deparse(f3), coef(mod3.3)["smoke"], confint(mod3.3)["smoke",]),</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   c(model="Mahalanobis Match", formula=deparse(f4), coef(mod4.1)["smoke"], confint(mod4.1)["smoke",]),</span></span>
<span><span class="co">#   c(model="Propensity Score Match", formula=deparse(f4), coef(mod4.2)["smoke"], confint(mod4.2)["smoke",]),</span></span>
<span><span class="co">#   c(model="Unmatched", formula=deparse(f4), coef(mod4.3)["smoke"], confint(mod4.3)["smoke",])</span></span>
<span><span class="co"># ) %&gt;% unlist() %&gt;% as.data.frame() %&gt;% </span></span>
<span><span class="co">#   mutate(across(smoke:`97.5 %`, as.numeric)) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># colnames(mod.comp) &lt;- c("model", "formula", "estimate", "CI2.5", "CI97.5")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># library(plotly)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ggplotly(ggplot(mod.comp, aes(x=estimate, y=paste0(model,"\n",formula), colour=model)) +</span></span>
<span><span class="co">#   geom_point() + geom_errorbarh(aes(xmin=CI2.5, xmax=CI97.5), height=0.2) +</span></span>
<span><span class="co">#   labs(y="Method and Formula for Producing Estimate", x="Estimate", color="Method"))</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># dagitty::localTests(fev.dag, md.matches, type="cis.chisq")</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(dplyr)</span></span>
<span><span class="co"># library(ggplot2)</span></span>
<span><span class="co"># devtools::load_all()</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #function to plot matches</span></span>
<span><span class="co"># plot.matches &lt;- function(md, title, lims=NULL){</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#     x.var &lt;- all.vars(md$formula)[2]</span></span>
<span><span class="co">#     y.var &lt;- all.vars(md$formula)[3]</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#     p &lt;- ggplot(md$matched.data, aes(.data[[x.var]], .data[[y.var]], group=subclass)) +</span></span>
<span><span class="co">#       geom_point(data=md$data, aes(.data[[x.var]], .data[[y.var]]), colour="black", alpha=0.3,</span></span>
<span><span class="co">#                  inherit.aes = F, size=3) + </span></span>
<span><span class="co">#       geom_point(aes(color=factor(t)), alpha=0.6, size=5) + </span></span>
<span><span class="co">#       geom_line(color="black") + </span></span>
<span><span class="co">#       labs(title=title, color="Treated")</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#     if(!is.null(lims)) p &lt;- p + xlim(lims[1]) + ylim(lims[2])</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     p</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #number of obs</span></span>
<span><span class="co"># n &lt;- 100</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #data frame with treatment and random covariates</span></span>
<span><span class="co"># d &lt;- list(t=c(rep(0,n*.6), rep(1,n*.4)),</span></span>
<span><span class="co">#           X1=rnorm(n, 50, 5), </span></span>
<span><span class="co">#           X2=rnorm(n, 40, 4)</span></span>
<span><span class="co">#           ) %&gt;% as.data.frame()</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># m.norep &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = F)</span></span>
<span><span class="co"># m.rep &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = T)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ggpubr::ggarrange(</span></span>
<span><span class="co"># plot.matches(m.norep, "Mahalanobis Matches without Replacement"),</span></span>
<span><span class="co"># plot.matches(m.rep, "Mahalanobis Matches with Replacement"), common.legend = T</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># </span></span>
<span><span class="co"># m.data &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Propensity Score", replace = F, order = "data")</span></span>
<span><span class="co"># m.small &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Propensity Score", replace = F, order = "smallest")</span></span>
<span><span class="co"># m.large &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Propensity Score", replace = F, order = "largest")</span></span>
<span><span class="co"># m.rand &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Propensity Score", replace = F, order = "random")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># m.PO &lt;- ggplot(m.data$matched.data, aes(X1, X2, group=subclass)) +</span></span>
<span><span class="co">#   geom_point(data=m.data$data, aes(X1, X2,fill=factor(t)),alpha=0.5, shape=21,</span></span>
<span><span class="co">#              inherit.aes = F, size=3) + </span></span>
<span><span class="co">#   # geom_point(aes(color=factor(t)), alpha=0.6, size=5) + </span></span>
<span><span class="co">#   geom_line(aes(linetype="data", color="data"), lwd=1, alpha=0.6) + </span></span>
<span><span class="co">#   geom_line(data=m.small$matched.data, aes(linetype="smallest",color="smallest"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   geom_line(data=m.large$matched.data, aes(linetype="largest",color="largest"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   geom_line(data=m.rand$matched.data, aes(linetype="random",color="random"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   labs(title="Propensity score matching using different match ordering", fill="Treated") +</span></span>
<span><span class="co">#   scale_linetype_manual(name="Ordering", values = c("data"=1, "smallest"=2, "largest"=3, "random"=4)) +</span></span>
<span><span class="co">#   scale_color_manual(name="Ordering", values = c("data"="black", "smallest"="blue", "largest"="darkgreen", "random"="red")) </span></span>
<span><span class="co">#   </span></span>
<span><span class="co"># m.data &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = F, order = "data")</span></span>
<span><span class="co"># m.small &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = F, order = "smallest")</span></span>
<span><span class="co"># m.large &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = F, order = "largest")</span></span>
<span><span class="co"># m.rand &lt;- WhatsMatching::matched.data(t~X1+X2, d, "Mahalanobis", replace = F, order = "random")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># m.MO &lt;- ggplot(m.data$matched.data, aes(X1, X2, group=subclass)) +</span></span>
<span><span class="co">#   geom_point(data=m.data$data, aes(X1, X2,fill=factor(t)),alpha=0.5, shape=21,</span></span>
<span><span class="co">#              inherit.aes = F, size=3) + </span></span>
<span><span class="co">#   # geom_point(aes(color=factor(t)), alpha=0.6, size=5) + </span></span>
<span><span class="co">#   geom_line(aes(linetype="data", color="data"), lwd=1, alpha=0.6) + </span></span>
<span><span class="co">#   geom_line(data=m.small$matched.data, aes(linetype="smallest",color="smallest"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   geom_line(data=m.large$matched.data, aes(linetype="largest",color="largest"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   geom_line(data=m.rand$matched.data, aes(linetype="random",color="random"), lwd=1, alpha=0.6) +</span></span>
<span><span class="co">#   labs(title="Propensity score matching using different match ordering", fill="Treated") +</span></span>
<span><span class="co">#   scale_linetype_manual(name="Ordering", values = c("data"=1, "smallest"=2, "largest"=3, "random"=4)) +</span></span>
<span><span class="co">#   scale_color_manual(name="Ordering", values = c("data"="black", "smallest"="blue", "largest"="darkgreen", "random"="red")) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ggpubr::ggarrange(</span></span>
<span><span class="co">#   m.PO, m.MO, common.legend = T, legend = "right"</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># </span></span></code></pre></div>
<p>The propensity score is a popular choice for matching but using it
appropriately has been a contentious topic in recent years. Letâ€™s look
at why that might be. Below, some data has been simulated with both
<code>X1</code> and <code>X2</code> being mediators between
<code>t</code> (the treatment variable) and <code>y</code> (the outcome
variable). There is a large treatment effect between <code>t</code> and
<code>X2</code> which carries on to <code>y</code>. We can see on the
plot below that there is complete separation between the treated and
control groups with respect to these covariates.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # library(WhatsMatching)</span></span>
<span><span class="co"># library(ggplot2)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #sample size</span></span>
<span><span class="co"># n &lt;- 200</span></span>
<span><span class="co"># #treatment effect</span></span>
<span><span class="co"># te &lt;- 4</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #treatment variable with less treated units</span></span>
<span><span class="co"># t &lt;- rbinom(200,1,0.4)</span></span>
<span><span class="co"># #covariates</span></span>
<span><span class="co"># X1 &lt;- rnorm(n,20,5)</span></span>
<span><span class="co"># X2 &lt;- rnorm(n,10,2)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># #lets make a big treatment effect on one of the covariates</span></span>
<span><span class="co"># #t*10 will double the value of X2 for treated units (on average)</span></span>
<span><span class="co"># X2 &lt;- X2 + t*2</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># y &lt;- t*te + X1 + X2 + rnorm(n)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dt &lt;- cbind(t, X1, X2, y) %&gt;% as.data.frame()</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dt %&gt;% ggplot() + geom_point(aes(X1, X2, color=factor(t)))</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mod &lt;- glm(formula=t~X1, data=dt, family="binomial")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># c(var="X1", estimate=coef(mod)["X1"], confint(mod)["X1",])</span></span>
<span><span class="co"># coef(mod)[["X1"]]</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dt.match &lt;- matched.data(t~X1, dt, "Mahalanobis")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># get.estimates(match.data=dt.match, f=y~t+X1+X2)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># lm(y~X1+X2, data=dt.match$data)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dt.match$treatment</span></span>
<span></span>
<span></span>
<span><span class="co"># a &lt;- c("smoke", "fev", "t", "y")[c("fev", "smoke", "t", "y") %in% colnames(fev)]</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># a &lt;- NULL</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># paste(NULL,a, sep="+", collapse=" ")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># noquote(paste("y", "~", "t", paste(NULL,NULL, sep="+ ", collapse = " ")))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># as.formula(t~y+X1)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jason Meyer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
