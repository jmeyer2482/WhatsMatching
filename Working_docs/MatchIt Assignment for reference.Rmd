---
title: "HDAT9700: Assessment 1A - Chapters 1-3"
output: github_document
author: "Jason Meyer"
date: "27/09/2021"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, error = F)
library(dagitty)
library(ggdag)
library(MatchIt)
library(tidyverse)

```

### Submission instructions
This is an R Markdown document, an example of *literate programming* which allows users to interweave text, statistical output and the code that produces that output. 

To complete your assignment:   

* Edit this file directly, interweaving text and R code as appropriate to answer the questions below. Remember to `Knit` the file to make sure everything is running smoothly. Detailed information on R Markdown is available [here](https://rmarkdown.rstudio.com/lesson-1.html), and there is a useful cheat sheet [here](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf).  

* Use Git to `commit` changes you make in this repo locally.   

* `Push` the repo, together with this edited `.Rmd` file, the corresponding `.md` file and any other relevant files to GitHub.  

You can `commit` and `push` as often as necessary---your assessment will be graded on the most recent version of your repo at the assessment due date. 

Good luck!


***

### Overview

In this assignment you are provided with observational data on maternal characteristics and birth outcomes. Your aim is to estimate the total causal effect of maternal smoking during pregnancy on birth weight.  

The data come from [Abrevaya (2006)](https://onlinelibrary.wiley.com/doi/abs/10.1002/jae.851) _Estimating the effect of smoking on birth outcomes using a matched panel data approach_. More details can be found [here](http://qed.econ.queensu.ca/jae/2006-v21.4/abrevaya/readme.ja.txt). The dataset has been restricted to mother's first birth and **for the purposes of this assignment can be treated as observational data generated through a simple random sample of births**. So the emphasis in this assignment is on drawing and understanding a DAG, implementing matching and correctly interpreting the results, you don't have to worry about sample corrections (e.g. weighting) or correcting for dependency in matched pairs. 

#### Here is a brief description of the available variables:                                         
* **momid** identification number of the mother                                    
* **idx** index number of a mother's birth                              
* **mage** age of mother (in years)                                               
* **gestat** length of gestation (in weeks)                                         
* **birwt** birthweight (in grams)
* **smoke** indicator variable for smoking status (1=smoker, 0=nonsmoker)
* **male** sex of the baby (1=male, 0=female)
* **collgrad** college-graduate indicator (1=graduate, 0=non-graduate)
* **black** indicator variable for black race (1=black, 0=white)

These data are contained in your assignment repo in the file `dt.rda`, which can be loaded as follows:

``` {r read-data}
load("dt.rda")
```

***

### Assessment questions 

(1) Draw a DAG to represent the causal relationship between maternal smoking and birth weight. Write a brief descriptive paragraph that highlights any backdoor path(s) and the observed variables that might be useful to close the path(s). (25%)

_Hint: Not all variables that appear in the dataset need to be on your DAG and not all nodes that are on your DAG will necessarily be observed variables. You can draw your DAG using whatever tool you prefer. Options include `ggdag()` in R, [daggity.net](http://dagitty.net/dags.html), a screenshot from a DAG drawn in MS Word etc, or an embedded picture of a DAG drawn with pen and paper._

(2) Match smokers to non-smokers using a matching method of your choice and matching variables that are consistent with your DAG. Briefly summarise the balance in both cases, drawing on appropriate numerical and graphical summaries. (25%)

(3) Fit the model birwt ~ smoke in (i) The raw data and (ii) the matched data. Briefly describe the model results. How does the estimated effect for smoking change and why? (25%)

(4) Briefly discuss any limitations of the model 3(ii) and argue whether or not the assumption of exchangeability is likely to hold. (25%)

***

### Solution 

#### (1) DAG  

Assumptions for relationships:  
- `momid` and `idx` not relevant as dataset restricted to first birth  
- Racial differences (particularly in the time of this data) may have larger socio-economic implications therefore the variable `black` causes changes in `smoke`, `mage`, and `collgrad`.  
- There are [differences in the sex birth rates between races](https://www.infoplease.com/us/population/births-sex-and-sex-ratio). `black` causes changes in `male`.  
- Race may [also have implications for low birthweight](https://bmcpregnancychildbirth.biomedcentral.com/articles/10.1186/s12884-014-0385-z). Therefore, `black` may directly change `birwt`.  
- The exposure, `smoke`, and the outcome, `birwt`, is what we are testing. Additionally, `smoke` causes [changes in `gestat`](https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2730781).  
- Whether you are a `collgrad` causes differences in if you `smoke` and what your `mage` may be.  
- The `gestat` has a direct impact on `birwt`. As does `male`.  
- [This article](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4296235/) and [this article](https://academic.oup.com/aje/article/186/11/1219/3858068) discuss the extensive research demonstrating a positive association between `mage` and both `gestat` and `birwt`. 

![Directed Acyclic Graph of variables in dataset](dagitty-model-1.png)

The backdoor paths in the above DAG have not been fully identified except for the most straightforward route from the exposure to the outcome. Additional backdoor paths that can be identified stem from either `black` or `collgrad` as follows:  
- `collgrad` $\rightarrow$ `black` $\rightarrow$ `birwt`  
- `collgrad` $\leftarrow$ `black` $\rightarrow$ `male` $\rightarrow$ `birwt`  
- `collgrad` $\leftarrow$ `black` $\rightarrow$ `mage` $\rightarrow$ `birwt`  
- `collgrad` $\rightarrow$ `mage` $\rightarrow$ `gestat` $\rightarrow$ `birwt`  
- `collgrad` $\rightarrow$ `mage` $\leftarrow$ `black` $\rightarrow$ `birwt`  
- `collgrad` $\leftarrow$ `black` $\rightarrow$ `mage` $\rightarrow$ `gestat` $\rightarrow$ `birwt`  
- `collgrad` $\rightarrow$ `mage` $\leftarrow$ `black` $\rightarrow$ `male` $\rightarrow$ `birwt`  
- `black` $\rightarrow$ `male` $\rightarrow$ `birwt`  
- `black` $\rightarrow$ `mage` $\rightarrow$ `birwt`  
- `black` $\rightarrow$ `mage` $\rightarrow$ `gestat` $\rightarrow$ `birwt`  
  
While there are many variables that are part of these backdoors we need only select two variables to close both of them. `black` is the only variable that will close all of the pathways on the backdoor going through `black`. `collgrad` and `mage` will both be adequate for closing the pathway going through `collgrad` as this pathway goes through either `black` or `mage` and we will already be including `black`.  
  
Therefore, the two best options for closing the backdoors would be to include `black` and `collgrad` or `black` and `mage`. 

#### (2) Matching  


```{r variables, include=FALSE}
#Let's have a quick look at the variables we are going to be matching on - 
#`mage`, `black`, `gestat`.

#variable distributions
#create a base for the plots
plot_base <- ggplot(dt, aes(y=after_stat(density), fill=as.character(smoke))) + 
  geom_histogram(alpha=0.5, position = "identity", bins = 15) +
  scale_fill_manual(values=c("#69b3a2", "#404080")) +
  scale_fill_discrete(name = "Smoker", labels = c("No", "Yes"))

#plot the histograms
plot_base + aes(x=mage)
plot_base + aes(x=black)
plot_base + aes(x=gestat)
plot_base + aes(x=collgrad)

```
  
I have elected to include `mage` and `black` as I believe that `mage` is a better variable to include in the model than `collgrad`. Additionally, I will include `gestat`. As noted above in the DAG, these 3 variables should account for any effects that might be caused by the other variables.


```{r tests, include=FALSE}

#load matches for comparison
match.cem <- matchit(smoke ~ black + mage + gestat, data=dt, method="cem")
match.exact <- matchit(smoke ~ black + mage + gestat, data=dt, method="exact")
match.prop <- matchit(smoke ~ black + mage + gestat, data=dt, method="nearest", ratio = 3)
match.mah <- matchit(smoke ~ black + mage + gestat, data=dt, method="nearest", distance = "mahalanobis", ratio = 3)


matches.test <- list(match.cem, match.exact, match.prop, match.mah)

#run matches through loop and compare outcomes
for (i in c(1:4)){
  sumMatch.test <- summary(matches.test[[i]])
  print(sumMatch.test)
  
  titles.test <- matches.test[[i]]$call
  # Save the summary info as two data frames
  sumAll.test <- tibble::rownames_to_column(as.data.frame(sumMatch.test$sum.all), var = 'variable')
  sumMatched.test <- tibble::rownames_to_column(as.data.frame(sumMatch.test$sum.matched), var = 'variable')
  # Join those data frames together (tidy data format!)
  df.test <- dplyr::bind_rows(sumAll.test, sumMatched.test, .id = 'source')
  # Plot
  p.test <- ggplot(df.test, aes(x = `Std. Mean Diff.`, y = variable, color = source, shape = source)) +
    geom_vline(aes(xintercept = 0), color = 'pink') +
    geom_point(size = 3) +
    scale_y_discrete('Variable') +
    scale_x_continuous('Standardised mean difference') +
    scale_color_manual(NULL, values = c('red', 'blue'), labels = c('Unmatched', 'Matched')) +
    scale_shape_manual(NULL, values = c(20, 15), labels = c('Unmatched', 'Matched')) + 
    labs(title = titles.test)
  
  print(p.test)
  
  print(plot(matches.test[[i]], type="QQ"))
  }
```

Options for matching:  
  
Type                         |  Suitability   
---------------------------- | ---------------------------------------------------   
Coarsened Exact Matching     |   Reduces the standardised means to almost 0. Only removes a small amount of records from each group. Likely to be a better fit than exact matching. Advantageous due to pruning in both control and treatment groups. Assessment: Moderate bias, moderate variance.  
Exact matching               |   Reduces the standardised means to 0. Highly biased and removes more records from each group. Advantageous due to pruning in both control and treatment groups. Assessment:  High bias, low variance.  
Nearest - Propensity score distance  |  Improves the standardised means but not as effectively as CEM or Exact Matching. Keeps all treatment records. Propensity scores match on aggregate score for selected data, not the data itself. Assessment: Low bias, high variance (can be mitigated somewhat by changing the ratio).  
Nearest - Mahalanobis distance       |  Improves the standardised means but not as effectively as CEM or Exact Matching. Struggled with `mage`. Keeps all treatment records and matches to nearest other record based on actual data. Assessment: Moderate bias, moderate to high variance (can be mitigated somewhat by changing the ratio). 
  
Based on the above assessments I will use Coarsened Exact Matching (CEM) as it removes unmatched data from both the treatment and control groups and multiple matches are allowed returning a more complete dataset. CEM retains the most records from both groups while also improving the stardardised means and the distribution of data. Having more complete data reduces bias but may increase variance. The variance should be somewhat balanced by the removal of outlier records from both groups.


```{r matching}

match <- matchit(smoke ~ black + mage + gestat, data=dt, method="cem")

sumMatch <- summary(match)
sumMatch
```

The above summary shows us that we have managed to keep a good proportion of the data (`r round((1-sum(match$nn[c(5,11)])/nrow(dt))*100,2)`%). Records have been taken out of both groups. This gives us some confidence that there is a balance between the bias and variance of the data.

```{r matching plots}
# Save the summary info as two data frames
sumAll <- tibble::rownames_to_column(as.data.frame(sumMatch$sum.all), var = 'variable')
sumMatched <- tibble::rownames_to_column(as.data.frame(sumMatch$sum.matched), var = 'variable')
# Join those data frames together (tidy data format!)
df <- dplyr::bind_rows(sumAll, sumMatched, .id = 'source')
# Plot
ggplot(df, aes(x = `Std. Mean Diff.`, y = variable, color = source, shape = source)) +
  geom_vline(aes(xintercept = 0), color = 'pink') +
  geom_point(size = 3) +
  scale_y_discrete('Variable') +
  scale_x_continuous('Standardised mean difference') +
  scale_color_manual(NULL, values = c('red', 'blue'), labels = c('Unmatched', 'Matched')) +
  scale_shape_manual(NULL, values = c(20, 15), labels = c('Unmatched', 'Matched'))
```

Plotting the standarised mean difference of the variables we have matched on shows a significant improvement in the balance between the groups.

```{r qqplot}
#QQ plot
plot(match, type="QQ")


```

The QQplot also visually confirms that the matched data is much more consistently distributed between the groups.  
  
If I was unhappy with the CEM results and I thought the automatic groupings were not suitable for the data, there is capacity to manually adjust them if there is a rational reason.  
  

#### (3) Fit the model

```{r models}
#get matched data
matched.data <- match.data(match, data = dt)


#create linear model of matched data and raw data
mod.matched <- lm(birwt ~ smoke, data=matched.data, weights=weights)
mod.all <- lm(birwt ~ smoke, data=dt)

#compare models
summary(mod.matched)
summary(mod.all)

#store coefficients
coefs <- c(round(mod.all$coefficients,1), round(mod.matched$coefficients,1))

```

Both models demonstrate very high statistical significance. The main difference in the outcomes are that using the raw data `smoke` contributes to a `r coefs[[2]]`g change in `birwt` whereas in the matched data `smoke` contributes to a `r coefs[[4]]`g change in `birwt`. The average `birwt` is `r coefs[[1]]`g for the raw data compared to `r coefs[[3]]`g for the matched data.  
  
The likely explanation for the lesser decrease in weight for the matched data is due to dropping outlier records in `gestat`, in particular the values that would be considered pre-term birth. The length of gestation has a large impact as pre-term babies are known to have significantly lower birth weights than full term babies. Therefore, it intuitively makes sense that the matched data would have less of a reduction in birth weight.  

#### (4) Limitations  

The limitations to the model include:  
i. a lack of domain knowledge which may lead to incorrect assumptions about the variable relationships in the DAG  
ii. there is no way of knowing the consistency of the exposure (e.g. how much a person smokes is not included in the data, only yes or no)  
iii. there is only a limited number of variables available to the model so we can't be 100% sure there isn't something else causing the difference in the groups  
iv. only 3 variables were used for matching which will likely result in increased variance and decreased bias however, these were the variables that needing accounting for based on my DAG  
  
In terms of exchangeability, I believe this criteria has been met as well as it can be in the circumstances. Exchangeability requires that the background characteristics are the same between the treated and untreated groups. If we look at the density histograms below we can see good overlap in the distributions based on the exposure. The variable I was most concerned about, `male`, appears to be evenly distributed. Furthermore, I believe I have rationalised the variables used in the model sufficiently.  
  
It's important to note that exchangeability can not be formally assessed and therefore, even though I have made my case above, I can't truly say if the groups meet the criteria for exchangeability.


```{r matched data plots}

#plot the histograms
for (i in c(3,4,7:9)){
  plot <- ggplot(matched.data, 
                 aes(x=matched.data[,i], y=after_stat(density), fill=as.character(smoke))) + 
    xlab(names(matched.data)[i]) +
    geom_histogram(alpha=0.5, position = "identity", bins = 15) +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    scale_fill_discrete(name = "Smoker", labels = c("No", "Yes"))
  
  print(plot)
  }


matched.data %>% 
  matchit(smoke ~ black + mage + gestat + male + collgrad, data = ., method=NULL) %>%
  summary()

```






***

### Student declaration

I declare that this assessment item is my own work, except where acknowledged, and has not been submitted for academic credit elsewhere or previously, or produced independently of this course (e.g. for a third party such as your place of employment) and acknowledge that the assessor of this item may, for the purpose of assessing this item: (i) Reproduce this assessment item and provide a copy to another member of the University; and/or (ii) Communicate a copy of this assessment item to a plagiarism checking service (which may then retain a copy of the assessment item on its database for the purpose of future plagiarism checking).  

- [x] I understand and agree

I certify that I have read and understood the University Rules in respect of Student Academic Misconduct.  

- [x] I understand and agree

I have a backup copy of the assessment.  

- [x] I understand and agree

